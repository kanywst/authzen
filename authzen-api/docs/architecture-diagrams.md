# Authorization API アーキテクチャ図解

## 目次

- [Authorization API アーキテクチャ図解](#authorization-api-アーキテクチャ図解)
  - [目次](#目次)
  - [基本アーキテクチャ](#基本アーキテクチャ)
  - [認証・認可フロー](#認証認可フロー)
  - [Istio/Envoy統合アーキテクチャ](#istioenvoy統合アーキテクチャ)
  - [データフロー](#データフロー)
  - [コンポーネント間の関係](#コンポーネント間の関係)

## 基本アーキテクチャ

```
+----------------------------------------------------------+
|                                                          |
|                    Kubernetes (Kind)                     |
|                                                          |
|  +-------------------+        +--------------------+     |
|  |                   |        |                    |     |
|  |  Authorization    |<-------+  アプリケーション     |     |
|  |  API (AuthZEN)    |        |                    |     |
|  |                   |        |                    |     |
|  +-------------------+        +--------------------+     |
|           |                                              |
|           v                                              |
|  +-------------------+                                   |
|  |                   |                                   |
|  |  ポリシーストア     |                                   |
|  |                   |                                   |
|  +-------------------+                                   |
|                                                          |
+----------------------------------------------------------+
```

## 認証・認可フロー

```
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | 認証    |                | アプリ   |
|        |                | サーバー  |                |        |
+--------+                +--------+                +--------+
    |                         |                         |
    | 1. 認証リクエスト         |                         |
    |------------------------>|                         |
    |                         |                         |
    | 2. JWT/トークン発行       |                         |
    |<------------------------|                         |
    |                         |                         |
    | 3. APIリクエスト + JWT    |                         |
    |-------------------------------------------------->|
    |                         |                         |
    |                         |                         |
+--------+                +--------+                +--------+
|        |                |        |                |        |
| アプリ    |                | AuthZEN |                | ポリシー |
|        |                | API     |                | ストア   |
+--------+                +--------+                +--------+
    |                         |                         |
    | 4. JWT検証              |                         |
    |--+                      |                         |
    |  |                      |                         |
    |<-+                      |                         |
    |                         |                         |
    | 5. 認可リクエスト         |                         |
    |------------------------>|                         |
    |                         |                         |
    |                         | 6. ポリシー照会          |
    |                         |------------------------>|
    |                         |                         |
    |                         | 7. 判定結果             |
    |                         |<------------------------|
    |                         |                         |
    | 8. 認可決定              |                         |
    |<------------------------|                         |
    |                         |                         |
    | 9. リソースアクセス       |                         |
    |--+                      |                         |
    |  |                      |                         |
    |<-+                      |                         |
    |                         |                         |
```

## Istio/Envoy統合アーキテクチャ

```
+----------------------------------------------------------+
|                                                          |
|                    Kubernetes (Kind)                     |
|                                                          |
|  +-------------------+        +--------------------+     |
|  |                   |        |                    |     |
|  |  Istio            |------->|  サンプルアプリ      |     |
|  |  Service Mesh     |        |                    |     |
|  |                   |        |                    |     |
|  +-------------------+        +--------------------+     |
|           |                                              |
|           v                                              |
|  +-------------------+        +--------------------+     |
|  |                   |        |                    |     |
|  |  Envoy Proxy      |<------>|  AuthZEN API       |     |
|  |  (サイドカー)      |        |                    |     |
|  |                   |        |                    |     |
|  +-------------------+        +--------------------+     |
|                                       |                  |
|                                       v                  |
|                               +--------------------+     |
|                               |                    |     |
|                               |  ポリシーストア      |     |
|                               |                    |     |
|                               +--------------------+     |
|                                                          |
+----------------------------------------------------------+
```

## データフロー

```
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | Envoy   |                | サービス  |
|        |                | Proxy   |                |        |
+--------+                +--------+                +--------+
    |                         |                         |
    | 1. リクエスト            |                         |
    |------------------------>|                         |
    |                         |                         |
    |                         | 2. External Authz       |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | Envoy   |                | AuthZEN |
|        |                | Proxy   |                | API     |
+--------+                +--------+                +--------+
    |                         |                         |
    |                         | 3. 認可リクエスト         |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |--+ 4. ポリシー評価
    |                         |                         |  |
    |                         |                         |<-+
    |                         |                         |
    |                         | 5. 認可決定 (ALLOW/DENY) |
    |                         |<------------------------|
    |                         |                         |
    |                         |--+ 6. 決定に基づいて      |
    |                         |  |    リクエスト処理      |
    |                         |<-+                      |
    |                         |                         |
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | Envoy   |                | サービス  |
|        |                | Proxy   |                |        |
+--------+                +--------+                +--------+
    |                         |                         |
    |                         | 7. リクエスト転送         |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |--+ 8. リクエスト処理
    |                         |                         |  |
    |                         |                         |<-+
    |                         |                         |
    |                         | 9. レスポンス            |
    |                         |<------------------------|
    |                         |                         |
    | 10. レスポンス           |                         |
    |<------------------------|                         |
    |                         |                         |
```

## コンポーネント間の関係

```
+---------------------+       +---------------------+
|                     |       |                     |
|  アプリケーション     |------>|  Authorization API  |
|                     |       |                     |
+---------------------+       +---------------------+
                                        |
                                        |
                                        v
+---------------------+       +---------------------+
|                     |       |                     |
|  認証サービス        |------>|  ポリシーストア      |
|  (JWT発行)          |       |                     |
+---------------------+       +---------------------+
        |
        |
        v
+---------------------+
|                     |
|  ユーザー/サービス    |
|  アイデンティティ     |
+---------------------+
```

このアーキテクチャ図は、Authorization API（AuthZEN準拠）の基本構成と、Istio/Envoyとの統合方法を示しています。認証と認可の連携フローも含まれており、システム全体の動作を理解するのに役立ちます。
