# 認証・認可とサービスメッシュの概要

## 目次

- [認証・認可とサービスメッシュの概要](#認証認可とサービスメッシュの概要)
  - [目次](#目次)
  - [認証と認可の基本概念](#認証と認可の基本概念)
  - [認証（Authentication）](#認証authentication)
    - [認証の種類](#認証の種類)
    - [JWTを使用した認証](#jwtを使用した認証)
  - [認可（Authorization）](#認可authorization)
    - [認可モデル](#認可モデル)
    - [Authorization APIの役割](#authorization-apiの役割)
  - [サービスメッシュ](#サービスメッシュ)
    - [Istioの概要](#istioの概要)
    - [Envoyプロキシ](#envoyプロキシ)
    - [External Authorization](#external-authorization)
  - [認証と認可の実装パターン](#認証と認可の実装パターン)
    - [JWTベースの認証](#jwtベースの認証)
    - [APIキー認証](#apiキー認証)
    - [相互TLS（mTLS）](#相互tlsmtls)
  - [まとめ](#まとめ)

## 認証と認可の基本概念

```
+-------------+    +-------------+    +-------------+
|             |    |             |    |             |
|    Who?     | -> |  Can they?  | -> | Do what?    |
| (認証)      |    | (認可)      |    | (アクション) |
|             |    |             |    |             |
+-------------+    +-------------+    +-------------+
```

**認証（Authentication）** と **認可（Authorization）** は、セキュリティの基本的な概念ですが、異なる役割を持っています：

- **認証**: ユーザーが「誰であるか」を確認するプロセス（IDの検証）
- **認可**: 認証されたユーザーが「何をする権限があるか」を決定するプロセス（権限の検証）

## 認証（Authentication）

認証は、システムにアクセスしようとするユーザーやサービスの身元を確認するプロセスです。

### 認証の種類

```
認証方式
+------------------+
|                  |
| 知識ベース        | -> パスワード、PIN、秘密の質問
|                  |
+------------------+
|                  |
| 所有ベース        | -> スマートカード、トークン、証明書
|                  |
+------------------+
|                  |
| 生体認証         | -> 指紋、顔認証、虹彩スキャン
|                  |
+------------------+
|                  |
| 多要素認証       | -> 上記の組み合わせ
|                  |
+------------------+
```

### JWTを使用した認証

JWT（JSON Web Token）は、クレームを安全に表現するためのコンパクトで自己完結型の方法です。

```
JWT構造
+------------------------------------------------------+
|                                                      |
| ヘッダー.ペイロード.署名                              |
|                                                      |
+------------------------------------------------------+

+-------------+    +-------------------+    +-------------+
|  ヘッダー    |    |     ペイロード     |    |    署名     |
| (アルゴリズム)|    | (クレーム情報)     |    | (検証用)    |
+-------------+    +-------------------+    +-------------+
      |                     |                     |
      v                     v                     v
  Base64URL            Base64URL              HMAC SHA256
   エンコード            エンコード          または RSA署名
```

**認証フロー**:

```
+--------+                               +--------+
|        |                               |        |
| クライアント|                               | 認証サーバー |
|        |                               |        |
+--------+                               +--------+
    |                                        |
    | 1. 認証情報（ユーザー名/パスワード）を送信  |
    |--------------------------------------->|
    |                                        |
    |                                        |--+ 2. 認証情報を検証
    |                                        |  |
    |                                        |<-+
    |                                        |
    | 3. JWT発行                             |
    |<---------------------------------------|
    |                                        |
    |--+ 4. JWTを保存                        |
    |  |                                     |
    |<-+                                     |
    |                                        |
+--------+                               +--------+
|        |                               |        |
| クライアント|                               | APIサーバー |
|        |                               |        |
+--------+                               +--------+
    |                                        |
    | 5. リクエスト + JWT                    |
    |--------------------------------------->|
    |                                        |
    |                                        |--+ 6. JWTを検証
    |                                        |  |
    |                                        |<-+
    |                                        |
    | 7. レスポンス                          |
    |<---------------------------------------|
    |                                        |
```

## 認可（Authorization）

認可は、認証されたユーザーやサービスが特定のリソースにアクセスしたり、特定のアクションを実行したりする権限があるかどうかを決定するプロセスです。

### 認可モデル

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|  RBAC            |     |  ABAC            |     |  ReBAC           |
| ロールベース      |     | 属性ベース        |     | 関係ベース        |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
        |                        |                        |
        v                        v                        v
+------------------+     +------------------+     +------------------+
| ユーザー -> ロール  |     | 主体、リソース、   |     | ユーザー -> 関係  |
| ロール -> 権限     |     | 環境の属性に基づく  |     | -> オブジェクト    |
+------------------+     +------------------+     +------------------+
```

### Authorization APIの役割

Authorization APIは、アプリケーションの認可ロジックを一元化し、一貫した認可決定を提供します。

```
+--------+                               +--------+
|        |                               |        |
| アプリケーション|                               | Auth API |
|        |                               |        |
+--------+                               +--------+
    |                                        |
    | 1. 認可リクエスト                       |
    | (principal, resource, action)         |
    |--------------------------------------->|
    |                                        |
    |                                        |--+ 2. ポリシー評価
    |                                        |  |
    |                                        |<-+
    |                                        |
    | 3. 認可決定 (ALLOW/DENY)               |
    |<---------------------------------------|
    |                                        |
    |--+ 4. 決定に基づいて                    |
    |  |    アクセス制御                      |
    |<-+                                     |
    |                                        |
```

**Authorization APIと認証の連携**:

```
+--------+     +--------+     +--------+     +--------+
|        |     |        |     |        |     |        |
| クライアント| --> | 認証サーバー| --> | アプリケーション| --> | Auth API |
|        |     |        |     |        |     |        |
+--------+     +--------+     +--------+     +--------+
    |              |              |              |
    | ユーザー情報    | JWT発行      | JWT検証      | 認可判断
    | 提供          |              | 認可リクエスト  |
    |              |              |              |
```

## サービスメッシュ

サービスメッシュは、マイクロサービスアーキテクチャにおけるサービス間通信を管理するインフラストラクチャレイヤーです。

### Istioの概要

Istioは、オープンソースのサービスメッシュで、マイクロサービス間の通信を制御、監視、セキュア化します。

```
Istioアーキテクチャ
+----------------------------------------------------------+
|                                                          |
|  +----------------+           +---------------------+    |
|  |                |           |                     |    |
|  |  コントロールプレーン |           |    データプレーン     |    |
|  |                |           |                     |    |
|  +----------------+           +---------------------+    |
|         |                              |                 |
|         v                              v                 |
|  +----------------+           +---------------------+    |
|  |                |           |                     |    |
|  |   Istiod       |---------->|   Envoyプロキシ      |    |
|  | (Pilot, Mixer, |           | (サイドカーとして     |    |
|  |  Citadel)      |           |  各サービスに注入)    |    |
|  |                |           |                     |    |
|  +----------------+           +---------------------+    |
|                                                          |
+----------------------------------------------------------+
```

### Envoyプロキシ

Envoyは、高性能なC++ベースのプロキシで、Istioのデータプレーンを形成します。

```
Envoyプロキシの機能
+----------------------------------------------------------+
|                                                          |
|  +----------------+    +----------------+                |
|  |                |    |                |                |
|  | ロードバランシング  |    | サーキットブレーカー |                |
|  |                |    |                |                |
|  +----------------+    +----------------+                |
|                                                          |
|  +----------------+    +----------------+                |
|  |                |    |                |                |
|  | ヘルスチェック    |    | 認証・認可       |                |
|  |                |    |                |                |
|  +----------------+    +----------------+                |
|                                                          |
|  +----------------+    +----------------+                |
|  |                |    |                |                |
|  | 監視・メトリクス   |    | トレーシング      |                |
|  |                |    |                |                |
|  +----------------+    +----------------+                |
|                                                          |
+----------------------------------------------------------+
```

### External Authorization

Envoyの External Authorization機能は、リクエストの認可判断を外部サービスに委任します。

```
External Authorization フロー
+--------+     +--------+     +--------+     +--------+
|        |     |        |     |        |     |        |
| クライアント| --> | Ingress | --> | Envoy   | --> | サービス  |
|        |     | Gateway |     | Proxy   |     |        |
+--------+     +--------+     +--------+     +--------+
                                 |  ^
                                 |  |
                                 v  |
                              +--------+
                              |        |
                              | Auth   |
                              | Service|
                              |        |
                              +--------+
```

**Istio/Envoy/AuthZEN統合フロー**:

```
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | Envoy   |                | サービス  |
|        |                | Proxy   |                |        |
+--------+                +--------+                +--------+
    |                         |                         |
    | 1. リクエスト            |                         |
    |------------------------>|                         |
    |                         |                         |
    |                         | 2. External Authz       |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | Envoy   |                | AuthZEN |
|        |                | Proxy   |                | API     |
+--------+                +--------+                +--------+
    |                         |                         |
    |                         | 3. 認可リクエスト         |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |--+ 4. ポリシー評価
    |                         |                         |  |
    |                         |                         |<-+
    |                         |                         |
    |                         | 5. 認可決定 (ALLOW/DENY) |
    |                         |<------------------------|
    |                         |                         |
    |                         |--+ 6. 決定に基づいて      |
    |                         |  |    リクエスト処理      |
    |                         |<-+                      |
    |                         |                         |
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | Envoy   |                | サービス  |
|        |                | Proxy   |                |        |
+--------+                +--------+                +--------+
    |                         |                         |
    |                         | 7. リクエスト転送         |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |--+ 8. リクエスト処理
    |                         |                         |  |
    |                         |                         |<-+
    |                         |                         |
    |                         | 9. レスポンス            |
    |                         |<------------------------|
    |                         |                         |
    | 10. レスポンス           |                         |
    |<------------------------|                         |
    |                         |                         |
```

## 認証と認可の実装パターン

### JWTベースの認証

JWT（JSON Web Token）は、クレームを安全に表現するためのコンパクトで自己完結型の方法です。認証と認可の連携において最も一般的に使用されるパターンの一つです。

```
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | 認証    |                | リソース |
|        |                | サーバー  |                | サーバー  |
+--------+                +--------+                +--------+
    |                         |                         |
    | 1. 認証情報を送信        |                         |
    |------------------------>|                         |
    |                         |                         |
    | 2. JWT発行              |                         |
    |<------------------------|                         |
    |                         |                         |
    | 3. JWT付きリクエスト      |                         |
    |------------------------------------------------->|
    |                         |                         |
    |                         |                         |--+ 4. JWTの検証
    |                         |                         |  |
    |                         |                         |<-+
    |                         |                         |
    |                         |                         |--+ 5. 認可チェック
    |                         |                         |  |   (AuthZEN API)
    |                         |                         |<-+
    |                         |                         |
    | 6. レスポンス            |                         |
    |<-------------------------------------------------|
    |                         |                         |
```

**実装のポイント**:

1. **認証サーバー**:
   - OpenID Connect対応のサーバー（Keycloak、Auth0など）を使用
   - JWTの署名と検証に使用する鍵ペアを管理
   - ユーザー情報とロールをJWTクレームに含める

2. **リソースサーバー**:
   - JWTの検証（署名、有効期限、発行者など）
   - JWTからユーザー情報とロールを抽出
   - AuthZEN APIに認可リクエストを送信

3. **AuthZEN API**:
   - JWTから抽出したユーザー情報を`principal`として使用
   - リクエストされたリソースと操作に基づいて認可判断

### APIキー認証

APIキーは、シンプルで実装が容易な認証方法です。主にサービス間通信やバックエンドAPIへのアクセスに使用されます。

```
+--------+                +--------+                +--------+
|        |                |        |                |        |
| クライアント |                | API     |                | AuthZEN |
|        |                | サーバー  |                | API     |
+--------+                +--------+                +--------+
    |                         |                         |
    | 1. APIキー付きリクエスト   |                         |
    |------------------------>|                         |
    |                         |                         |
    |                         |--+ 2. APIキーの検証      |
    |                         |  |                      |
    |                         |<-+                      |
    |                         |                         |
    |                         | 3. 認可リクエスト         |
    |                         |------------------------>|
    |                         |                         |
    |                         | 4. 認可決定              |
    |                         |<------------------------|
    |                         |                         |
    | 5. レスポンス            |                         |
    |<------------------------|                         |
    |                         |                         |
```

**実装のポイント**:

1. **APIキー管理**:
   - 安全なAPIキーの生成と保存
   - APIキーとユーザー/サービスの対応関係の管理
   - APIキーのローテーションと失効メカニズム

2. **APIサーバー**:
   - リクエストヘッダーからAPIキーを抽出
   - APIキーの検証とユーザー/サービスの特定
   - AuthZEN APIに認可リクエストを送信

3. **AuthZEN API**:
   - APIキーに関連付けられたユーザー/サービスを`principal`として使用
   - リクエストされたリソースと操作に基づいて認可判断

### 相互TLS（mTLS）

相互TLS（mTLS）は、クライアントとサーバーの両方が証明書を使用して互いを認証する方法です。Istioなどのサービスメッシュでは、サービス間通信のセキュリティを確保するために広く使用されています。

```
+--------+                +--------+                +--------+
|        |                |        |                |        |
| サービスA |                | Envoy   |                | サービスB |
|        |                | Proxy   |                |        |
+--------+                +--------+                +--------+
    |                         |                         |
    | 1. リクエスト            |                         |
    |------------------------>|                         |
    |                         |                         |
    |                         |--+ 2. mTLSハンドシェイク |
    |                         |  |                      |
    |                         |  |                      |
    |                         |  |                      |
    |                         |  |                      |
    |                         |<-+                      |
    |                         |                         |
    |                         | 3. mTLSで保護された通信   |
    |                         |------------------------>|
    |                         |                         |
    |                         |                         |--+ 4. 認可チェック
    |                         |                         |  |   (AuthZEN API)
    |                         |                         |<-+
    |                         |                         |
    |                         | 5. レスポンス            |
    |                         |<------------------------|
    |                         |                         |
    | 6. レスポンス            |                         |
    |<------------------------|                         |
    |                         |                         |
```

**実装のポイント**:

1. **証明書管理**:
   - サービス証明書の発行と管理（Istio Citadelなど）
   - 証明書のローテーションと失効メカニズム
   - 信頼できるCA（認証局）の設定

2. **Envoy Proxy**:
   - mTLSの設定と強制
   - クライアント証明書からサービスIDを抽出
   - AuthZEN APIへの認可リクエスト

3. **AuthZEN API**:
   - 証明書から抽出したサービスIDを`principal`として使用
   - リクエストされたリソースと操作に基づいて認可判断

## まとめ

認証と認可は、セキュアなシステムを構築するための基本的な要素です。AuthZEN APIは、様々な認証方法と組み合わせて使用することができ、一貫した認可モデルを提供します。Istioなどのサービスメッシュと統合することで、マイクロサービスアーキテクチャにおける認可制御をさらに強化することができます。

適切な認証・認可戦略を選択する際には、以下の点を考慮することが重要です：

1. **セキュリティ要件**: システムが保護するデータの機密性と重要性
2. **ユーザー体験**: 認証プロセスの使いやすさとユーザーへの影響
3. **スケーラビリティ**: 大規模なシステムでの認証・認可の性能
4. **相互運用性**: 異なるシステムやサービス間での認証・認可情報の共有
5. **管理のしやすさ**: 認証・認可ポリシーの管理と更新の容易さ

AuthZEN APIとIstio/Envoyの統合は、これらの要件をバランス良く満たすソリューションを提供し、モダンなマイクロサービスアーキテクチャにおける認証・認可の課題に対応します。
